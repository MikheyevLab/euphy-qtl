---
title: "Euphy qtl"
author: "Sasha Mikheyev"
date: "4/25/2018"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(scatterD3)
library(sequoia)
parents <- c("BCU-106-E2-PARENT","106-F2-PARENT", "306-VIP")
```

Generated by
```
vcftools --vcf freebayes.vcf --max-missing 0.9 --maf 0.2  --recode
```
```{r echo=F}
miss <-read_tsv("data/out.imiss", col_types = cols())
euphyDist <- read_tsv("data/freebayes.txt", col_name=F, col_types = cols())
b <- as.dist(euphyDist[,-1])
b.mds <- cmdscale(b, k=2)
rownames(b.mds) <- euphyDist$X1
with(as.data.frame(b.mds) %>%  rownames_to_column(var="id") %>% mutate(family=ifelse(grepl("306",id) & ! grepl("106",id),"306",ifelse(!grepl("306",id) & grepl("106",id), "106", "else"))) %>% left_join(miss, by=c("id" = "INDV")) %>% filter(family != "else") %>% separate(id, into=c('fam','clutch'), extra="drop", remove=FALSE) %>% filter(! clutch %in% c("106", "108", "F2", "VIP")) ,  scatterD3(x = V1, y = V2, size_var = F_MISS, size_range = c(30,30), opacity=1-F_MISS, hover_size = 4, hover_opacity = 1, symbol_var = fam, col_var = clutch, tooltip_text = id, width= 800, height=800))
```

V1 -0.05 separates the two families provisionally
V2 -1 separates really bad samples, which tend to blur into each other

Label samples:

```{r}
with(as.data.frame(b.mds) %>%  rownames_to_column(var="id") %>% mutate(family=ifelse(grepl("306",id) & ! grepl("106",id),"306",ifelse(!grepl("306",id) & grepl("106",id), "106", "else"))) %>% left_join(miss, by=c("id" = "INDV")) %>% separate(id, into=c('fam','clutch'), extra="drop", remove=FALSE),  scatterD3(x = V1, y = V2, size_var = F_MISS, size_range = c(30,30), opacity=1-F_MISS, hover_size = 4, hover_opacity = 1, symbol_var = family, col_var = clutch, tooltip_text = id, width= 800, height=800))
```


```{r badSamples}
labelFam <- read_tsv("data/labelFam.txt")
checkFam <- as.data.frame(b.mds) %>%  rownames_to_column(var="id") %>% left_join(labelFam, by="id") %>% mutate(geneFam = ifelse(V1 < -0.05, "306", "106"), badFam = ifelse(labelFam != geneFam & labelFam != "check" & labelFam != "F1", "bad", "ok")) 
table(checkFam$badFam == "ok")
checkFam[checkFam$badFam == "bad",]
with(checkFam, scatterD3(x = V1, y = V2, hover_size = 4, hover_opacity = 1, col_var = geneFam, symbol_var = badFam, tooltip_text = id, width= 800, height=800))

fam <- checkFam %>% filter(badFam == "ok" | id %in% parents) %>% select(geneFam, id) %>% mutate(father = ifelse(id %in% parents, "0", "BCU-106-E2-PARENT"), mother = ifelse(id %in% parents, "0", ifelse(geneFam == "306", "306-VIP", "106-F2-PARENT"))) 
fam$phenotype <- fam$sex <-  0
fam[fam$id %in% parents[-1],"sex"] <- 2
fam[fam$id %in% parents[1],"sex"] <- 1
fam[fam$id %in% parents[1],"geneFam"] <- "306"
#fam <- rbind(fam, data.frame(geneFam = c("106",0,0), id = c(parents[1],"F0female", "F0male"), father = c("F0male",0,0), mother = c("F0female", 0,0), sex = c(1,2,1), phenotype = c(0,0,0))) # add grandparents
fam <- rbind(fam, data.frame(geneFam = c("106"), id = c(parents[1]), father = c(0), mother = c(0), sex = c(1), phenotype = c(0))) # add grandparents

write_tsv(fam, "data/ped.txt", col_names=F)
```

```{r sequoia}
seqDat <- read_tsv("data/nomiss.tsv") %>% select(-c(`#CHROM`,POS,REF))
keep <- colSums(seqDat == -9) <= 10  # get rid of a few individuals that are bad
lifehist <- data.frame(ID=colnames(seqDat), Sex = 3, BY=2016)
lifehist[lifehist$ID %in% parents[-1],"Sex"] <- 1
lifehist[lifehist$ID %in% parents[1],"Sex"] <- 2
lifehist[lifehist$ID %in% parents,"BY"] <- 2015
seqOut <- sequoia(t(seqDat)[keep,], lifehist[keep,], FindMaybeRel = F, MaxSibIter = 4, MaxSibshipSize = 200, CalcLLR = F, MaxMismatch = 20, Err = 0.01)
```


cat ped.txt | /apps/unit/MikheyevU/lepmap3/0.2/transpose_tab | awk '{print "CHR\tPOS\t" $0}' >! ped_t.txt


Misc notes:

306 VIP
BCU-106-E2-PARENT: really bad data, but potentially important sample
106 F2 PARENT: 106 Mom


"106-F2-parent"   FINE!   This should be a headless female, the F1 mother of the F2 samples labeled "106."  

"BCU 106 E2 parent"  YUERGH!!  This has to be a mis-read!  Obviously "E2" must be "F2."  Could BCU 106 be a mis-read for BLU6?    See list above.   Our guess is that this is the male F1 mate of the "106-F2-parent" listed above.  Is it a headless male?  Can you check visually?


Notes from Mike about codes
The samples in your file are labeled A, B, Z or T.  T is for "taste" meaning that the larva chewed at the edge of the leaf for less than 30 seconds and did not leave a visible hole.  Z is for Zero, meaning that the kiddie did not even taste.  A and B are for different lengths of meal, A is a short meal (we think 30 secs to 1 and a half minutes) and B is a longer one, a good-sized meal.  So clearly we have a lot of variation here!  We recommend NOT using samples labeled "Z" for pedic phenotype, though of course they may be useful for developmental rate.  The reason is that halfway thru the experiment we discovered that some larvae who failed to taste would feed happily if we cut the leaf open, while others continued to turn up their mandibles.  So the Z category is complex and we did not split it up, as we will do if we go through this procedure again.  The clearest difference is between T and B, so perhaps the most useful analysis would be to begin by just comparing those two categories?  (and adding in the samples sent with Vienna, that can easily be placed into those categories from the continuously variable data).

With respect to egg developmental rate, the first number after each clutch is simply the clutch ID, the second is the order of hatch.  So at the top of your list you have 106-3-1-B, and later I see 106-3-4-T and 106-3-3T;  These samples are from the third clucth laid by 106.  106-3-1 is from the earliest hatching group and 106-3-4 is from the foiurth group to hatch, so quite a bit later.  T and B are the pedic-feeding phenotypes.   Accurate classifcation of hatch time requires wathcing the eggs continuously and we weren't able to do that, so some clutches are classified into only 2 or 3 time periods while others have 6 or 7.  "EM" is the worst scenario, a combination of early and mid, so prolly should not be used.  A small number of samples are classified as E for early, L for late, VL for VERY LATE, rather than indicating hatch time by group number.  The VL samples are extreme and should be useful.  NOTE that the samples sent with Vienna also have hatch times and should be included here.


## F0
TR granny was TR BLU 6
"BCU-106-E2-PARENT"", son of BLU 6, mated to everyone